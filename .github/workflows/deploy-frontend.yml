name: Deploy VoxDem Frontend to UFPR Server

# Trigger deployment only on push to main branch
on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  deploy-frontend:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ”„ Checkout do CÃ³digo
        uses: actions/checkout@v3

      - name: ğŸ”‘ Configurar SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: ğŸ³ Build Docker Image Frontend
        run: |
          # Build da aplicaÃ§Ã£o VoxDem Frontend
          docker build -t voxdem-frontend:latest .
          
          # Salvar imagem como arquivo tar
          docker save voxdem-frontend:latest > voxdem-frontend.tar

      - name: ğŸ“¦ Transfer Frontend files to server
        run: |
          # Criar diretÃ³rio no servidor se nÃ£o existir
          ssh root@${{ secrets.SSH_HOST }} "mkdir -p /opt/voxdem-frontend"
          
          # Transferir arquivos necessÃ¡rios
          scp voxdem-frontend.tar root@${{ secrets.SSH_HOST }}:/opt/voxdem-frontend/
          scp docker-compose.frontend.yml root@${{ secrets.SSH_HOST }}:/opt/voxdem-frontend/

      - name: ğŸš€ Deploy VoxDem Frontend no servidor
        run: |
          ssh root@${{ secrets.SSH_HOST }} "cd /opt/voxdem-frontend && \
            docker compose -f docker-compose.frontend.yml down 2>/dev/null || true && \
            docker rmi voxdem-frontend:latest 2>/dev/null || true && \
            docker load < voxdem-frontend.tar && \
            SERVER_IP=\$(hostname -I | awk '{print \$1}') && \
            echo '# ConfiguraÃ§Ãµes de produÃ§Ã£o do VoxDem Frontend' > .env && \
            echo \"NEXT_PUBLIC_VOXDEM_API_URL=http://\${SERVER_IP}:3001/api\" >> .env && \
            echo 'NODE_ENV=production' >> .env && \
            echo 'PORT=3000' >> .env && \
            echo \"# Deploy em \$(date)\" >> .env && \
            echo 'DEPLOY_VERSION=latest' >> .env && \
            echo 'âœ… Arquivo .env criado:' && cat .env && \
            (docker network ls | grep -q 'voxdem-network' || docker network create voxdem-network) && \
            docker compose -f docker-compose.frontend.yml up -d && \
            echo 'â³ Aguardando Frontend...' && sleep 30 && \
            echo 'ğŸ“Š Status dos containers:' && docker compose -f docker-compose.frontend.yml ps && \
            rm -f voxdem-frontend.tar && \
            echo 'âœ… Deploy do VoxDem Frontend concluÃ­do!' && \
            echo \"ğŸ“ VoxDem Frontend disponÃ­vel em: http://\${SERVER_IP}:3002\" && \
            echo \"ğŸ”— Backend configurado em: http://\${SERVER_IP}:3001/api\""

      - name: ğŸ” Health Check Frontend
        run: |
          ssh root@${{ secrets.SSH_HOST }} << 'EOF'
            # Aguardar aplicaÃ§Ã£o subir
            sleep 20
            
            # Verificar se Frontend estÃ¡ respondendo
            if curl -f http://localhost:3002 2>/dev/null; then
              echo "âœ… VoxDem Frontend estÃ¡ funcionando!"
            else
              echo "âŒ VoxDem Frontend nÃ£o estÃ¡ respondendo"
              echo "ğŸ“‹ Logs da aplicaÃ§Ã£o:"
              docker compose -f /opt/voxdem-frontend/docker-compose.frontend.yml logs --tail=20 voxdem-frontend
              exit 1
            fi
          EOF

      - name: ğŸ§¹ Cleanup
        run: |
          # Limpar arquivos locais
          docker rmi voxdem-frontend:latest || true
          rm -f voxdem-frontend.tar
